<!DOCTYPE html>
<html>

<head>
  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

    #map {
      height: 100%;
    }
    /* Optional: Makes the sample page fill the window. */

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    window.currentTrackPointId = 595;
    window.calculatedThermailsViews = [];
    var map;
    function initMap() {
      window.map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: { lat: 46.48991, lng: 11.7614 },
        mapTypeId: 'terrain'
      });

      console.log("Rendering thermails from XCGlobe")
      renderTrackThermails(window.map, window.flightBoxData.thermails);

      console.log("Rendering flight track");
      renderTrack(window.map, window.trackData);
    }
  </script>

  <script>
    // Rendering routines
    function renderTrackThermails(map, thermails) {
      for (therm of thermails) {
        renderThermail(map, therm, {
          zIndex:100,
          fillColor: 'blue',
          zIndex: 0
        });
      };
    }

    function renderCalculatedThermailsForTrackPointId(trackPointId, map, thermails) {
      const countOfPriorThermailsToShow = 2;
      const nearestThermailIdx = -1 + thermails.findIndex(function (therm) {
        return therm.trackPointId > trackPointId
      });
      console.log("trackPointId = ", trackPointId);
      console.log("NearestThermailIdx = ", nearestThermailIdx);
      if (nearestThermailIdx < 0) {
        return [];
      }

      const therm  = thermails[nearestThermailIdx];
      console.log("Rendering thermail = ", therm);
      thermView = renderThermail(map, therm, {
          zIndex: 100,
          fillColor: determinationColor(therm.r2), 
          fillOpacity: 0.5
        });
      return [thermView];

      // const startIdx = Math.max(0, nearestThermailIdx - countOfPriorThermailsToShow);
      // const endIdx = nearestThermailIdx;

      // for (let i = startIdx; i <= endIdx; i++) {
      //   const therm  = thermails[i];
      //   const opacity = 0.1 + i * 0.4 * (i-startIdx)/(endIdx - startIdx); // from 0.1 to 0.5
      //   renderThermail(map, therm, {
      //     zIndex: 100,
      //     fillColor: determinationColor(therm.r2), 
      //     fillOpacity: opacity
      //   });
      // };
    }

    function renderAllCalculatedThermails(map, thermails) {
      for (therm of thermails) {
        renderThermail(map, therm, {
          zIndex:100,
          fillColor: determinationColor(therm.r2)
        });
      };
    }

    function renderThermail(map, therm, options) {
        circle = new google.maps.Circle({
          map: map,
          center: therm.center,
          radius: therm.radius,
          fillOpacity: 0.5,
          strokeWeight: 1,
          ...options
        });
        return circle;
    }

    function destroyRenderedThermail(thermailView){
      console.debug("Destroying thermail");
      thermailView.setMap(null);
    }

    function renderTrack(trackData) {
      new google.maps.Polyline({
        map: map,
        path: window.trackData.points,
        strokeWeight: 2,
        strokeColor: 'yellow'
      });
    }

    function determinationColor(determinationCoeff) {
      // Assuming 0.60 is the lowest determination possible
      const minCoeffValue = 0.6;
      const trimmedValue = Math.max(determinationCoeff - minCoeffValue, 0);
      const normalizedValue = trimmedValue / (1 - minCoeffValue);
      return redYellowGreenLerp(normalizedValue);
    }

    function redYellowGreenLerp(value) {
      // Color linear interpolation
      // red color for 0,
      // yellow for 0.5,
      // green for 1.0
      const lowHue = 0; //red
      const hightHue = 120; //green
      const hue = lowHue + (hightHue - lowHue) * value;
      return 'hsl(' + hue + ', 100%, 50%)';
    }
  </script>
  <script> 
    // Data loading routines
    function flightBoxDataFetchedCallback(data) {
      console.log("Thermails loaded: ", data.thermails.length);
      window.flightBoxData = data;
    }

    function calculatedDataFetchedCallback(data) {
      console.log("Thermails loaded: ", data.thermails.length);
      window.calculatedData = data;
    }

    function trackDataFetchedCallback(data) {
      console.log("Track is loaded");
      window.trackData = data;
    }
  </script>

  <script>
    // User interaction handling
    function handleKeyPress(e){
      console.log(`Key ${e.code} pressed`);

      // Remove previously rendered calculated thermails
      window.calculatedThermailsViews.forEach(destroyRenderedThermail);
      window.calculatedThermailsViews = [];

      const trackPointsCount = window.trackData.points.length;
      if (e.code === 'KeyD'){
        window.currentTrackPointId = Math.min(window.currentTrackPointId + 10, trackPointsCount);  
      } else if (e.code === 'KeyA'){
        window.currentTrackPointId = Math.max(window.currentTrackPointId - 10, 0);  
      } else {
        return;
      }

      window.calculatedThermailsViews = renderCalculatedThermailsForTrackPointId(
        window.currentTrackPointId,
        window.map,
        window.calculatedData.thermails
      );
    }
    window.addEventListener('keydown', handleKeyPress);
  </script>
  <script src="data/xc-thermails.js"></script>
  <script src="data/calculated_thermails.js"></script>
  <script src="data/igc-track.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCM-8hga1cAOBlE2a9ssL95G3SCMXh5B8o&callback=initMap">

  </script>
</body>

</html>