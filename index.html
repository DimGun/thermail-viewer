<!DOCTYPE html>
<html>

<head>
  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

    #map {
      height: 100%;
    }
    /* Optional: Makes the sample page fill the window. */

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    var map;
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: { lat: 46.48991, lng: 11.7614 },
        mapTypeId: 'terrain'
      });

      for (therm of window.flightBoxData.thermails) {
        console.log(therm);
        circle = new google.maps.Circle({
          map: map,
          center: therm.center,
          radius: therm.radius,
          fillColor: 'blue',
          fillOpacity: 0.5,
          zIndex: 0,
          strokeWeight: 1
        });
      };

      console.log("Rendering calculated data");
      for (therm of window.calculatedData.thermails) {
        console.log(therm);
        circle = new google.maps.Circle({
          map: map,
          center: therm.center,
          radius: therm.radius,
          fillColor: determinationColor(therm.r2),
          fillOpacity: 0.5,
          strokeWeight: 0.5, 
          zIndex: 100
        });
      };

      console.log("Rendering flight track");
      new google.maps.Polyline({
        map: map,
        path: window.trackData.gpts,
        strokeWeight: 2,
        strokeColor: 'yellow'
      });
    }

    function determinationColor(determinationCoeff) {
      // Assuming 0.60 is the lowest determination possible
      const minCoeffValue = 0.6;
      const trimmedValue = Math.max(determinationCoeff - minCoeffValue, 0);
      const normalizedValue = trimmedValue / (1 - minCoeffValue);
      return redYellowGreenLerp(normalizedValue);
    }

    function redYellowGreenLerp(value) {
      // Color linear interpolation
      // red color for 0,
      // yellow for 0.5,
      // green for 1.0
      const lowHue = 0; //red
      const hightHue = 120; //green
      const hue = lowHue + (hightHue - lowHue) * value;
      return 'hsl(' + hue + ', 100%, 50%)';
    }

    function flightBoxDataFetchedCallback(data) {
      console.log("Thermails loaded: ", data.thermails.length);
      window.flightBoxData = data;
    }

    function calculatedDataFetchedCallback(data) {
      console.log("Thermails loaded: ", data.thermails.length);
      window.calculatedData = data;
    }

    function trackDataFetchedCallback(data) {
      console.log("Track is loaded");
      window.trackData = data;
    }
  </script>
  <script src="data/xc-thermails.js"></script>
  <script src="data/calculated_thermails.js"></script>
  <script src="data/xc-track.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCM-8hga1cAOBlE2a9ssL95G3SCMXh5B8o&callback=initMap">

  </script>
</body>

</html>